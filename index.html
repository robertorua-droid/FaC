<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Cloud - Professionisti</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Stile personalizzato -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Schermata di Login -->
    <div id="login-container" class="container">
        <div class="row justify-content-center align-items-center vh-100">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title text-center mb-4">Accesso Cloud</h3>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <div id="login-error" class="text-danger mb-3 d-none">Credenziali errate.</div>
                            <button type="submit" class="btn btn-primary w-100" id="btn-login-submit">
                                <span id="login-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                Accedi
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schermata Caricamento -->
    <div id="loading-screen" class="d-flex justify-content-center align-items-center vh-100 d-none bg-white" style="position:fixed; top:0; left:0; width:100%; z-index:2000;">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-3 lead">Sincronizzazione Cloud...</p>
        </div>
    </div>

    <!-- Applicazione Principale -->
    <div id="main-app" class="d-none">
        <div class="sidebar">
            <h4 class="text-center my-3" id="company-name-sidebar">MIO STUDIO</h4>
            <p class="text-center text-white-50 small" id="user-name-sidebar"></p>
            <p class="text-center text-white-50" style="font-size: 0.7rem;" id="version-sidebar">v9.7 (Stable Cloud)</p>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" data-target="home"><i class="fas fa-home"></i> Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-target="statistiche"><i class="fas fa-chart-line"></i> Statistiche</a></li>

                <li class="nav-item"><h6 class="nav-section-title">Anagrafiche</h6></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="anagrafica-clienti"><i class="fas fa-users"></i> Clienti</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-target="anagrafica-prodotti"><i class="fas fa-box"></i> Servizi</a></li>
                
                <li class="nav-item"><h6 class="nav-section-title">Documenti</h6></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#newInvoiceChoiceModal" id="menu-nuova-fattura"><i class="fas fa-file-invoice-dollar"></i> Nuova Fattura</a></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="nuova-fattura-accompagnatoria" id="menu-nuova-nota-credito"><i class="fas fa-file-download"></i> Nuova Nota Credito</a></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="elenco-fatture"><i class="fas fa-list-ol"></i> Elenco Documenti</a></li>
                
                <li class="nav-item"><h6 class="nav-section-title">Impostazioni</h6></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="anagrafica-azienda"><i class="fas fa-building"></i> Azienda</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-target="avanzate"><i class="fas fa-cloud-upload-alt"></i> Migrazione</a></li>

                <li class="nav-item mt-auto"><a class="nav-link" href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="main-content">
            
            <!-- HOME -->
            <div id="home" class="content-section">
                <h2 id="welcome-message">Benvenuto</h2>
                <p id="current-datetime" class="lead"></p>
                <hr>
                <div class="row mt-4">
                    <div class="col-md-6 col-lg-5 mb-4"><div id="calendar-widget"></div></div>
                    <div class="col-md-6 col-lg-5 mb-4">
                        <div id="notes-widget" class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-clipboard"></i> Block-notes Cloud</h5>
                                <textarea id="notes-textarea" class="form-control" rows="8" placeholder="Scrivi qui i tuoi appunti..."></textarea>
                                <button class="btn btn-primary btn-sm mt-2" id="save-notes-btn">Salva note</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STATISTICHE -->
            <div id="statistiche" class="content-section d-none">
                <h2>Riepilogo Fatturato</h2>
                <div class="d-flex align-items-center gap-2 mb-3">
                    <label for="stats-year-filter" class="form-label mb-0">Anno</label>
                    <select id="stats-year-filter" class="form-select form-select-sm" style="max-width:160px">
                        <option value="all">Tutti</option>
                    </select>
                </div>

                <div id="stats-table-container"></div>
                <hr class="my-4">
                <h2>Simulazione Fiscale</h2>
                <div id="tax-simulation-container"></div>
            </div>

            <!-- CLIENTI -->
            <div id="anagrafica-clienti" class="content-section d-none">
                <h2>Anagrafica Clienti <button class="btn btn-success float-end" id="newCustomerBtn"><i class="fas fa-plus"></i> Nuovo Cliente</button></h2>
                <table class="table table-hover"><thead><tr><th>Ragione Sociale</th><th>P.IVA / C.F.</th><th>S.d.I.</th><th>Indirizzo</th><th class="text-end">Azioni</th></tr></thead><tbody id="customers-table-body"></tbody></table>
            </div>

            <!-- SERVIZI -->
            <div id="anagrafica-prodotti" class="content-section d-none">
                <h2>Anagrafica Servizi <button class="btn btn-success float-end" id="newProductBtn"><i class="fas fa-plus"></i> Nuovo Servizio</button></h2>
                <table class="table table-hover"><thead><tr><th>Codice</th><th class="col-description">Descrizione</th><th class="text-end-numbers col-price pe-5">Prezzo</th><th class="text-end-numbers">IVA</th><th class="text-end col-actions">Azioni</th></tr></thead><tbody id="products-table-body"></tbody></table>
            </div>

            <!-- ELENCO FATTURE -->
            <div id="elenco-fatture" class="content-section d-none">
                <h2>Documenti Emessi</h2>
                
<div class="mb-3 d-flex align-items-center gap-2">
    <label for="invoice-year-filter" class="form-label mb-0 me-2">Anno:</label>
    <select id="invoice-year-filter" class="form-select form-select-sm" style="width:auto; max-width:150px;">
        <option value="all">Tutti</option>
    </select>
</div>
                <table class="table table-hover"><thead><tr><th>Tipo</th><th>Numero</th><th>Data</th><th>Cliente</th><th class="text-end-numbers">Totale</th><th class="text-end-numbers">Scadenza</th><th>Stato</th><th class="text-end col-actions">Azioni</th></tr></thead><tbody id="invoices-table-body"></tbody></table>
            </div>
            
            <!-- NUOVA FATTURA / NOTA CREDITO -->
            <div id="nuova-fattura-accompagnatoria" class="content-section d-none">
                <h2 id="document-title">Nuovo Documento</h2>
                <form id="new-invoice-form">
                    <!-- ID SISTEMA VISIBILE -->
                    <div class="mb-3 p-2 bg-light border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="small text-muted fw-bold">ID Interno (Sistema)</label>
                                <input type="text" class="form-control-plaintext fw-bold" id="invoice-id" readonly placeholder="Nuovo Documento">
                            </div>
                            <div class="col-md-6">
                                <label class="small text-muted fw-bold">Tipo Documento</label>
                                <input type="text" class="form-control-plaintext" id="document-type" readonly value="Fattura">
                            </div>
                        </div>
                    </div>

                    <div id="credit-note-fields" class="row d-none bg-warning-subtle p-3 rounded mb-3 border border-warning">
                        <div class="col-md-6 mb-3"><label class="form-label">Fattura da Rettificare</label><input type="text" class="form-control" id="linked-invoice" placeholder="Es. FATT-2025-01"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Causale</label><input type="text" class="form-control" id="reason"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Cliente</label><select class="form-select" id="invoice-customer-select" required></select></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Data Documento</label><input type="date" class="form-control" id="invoice-date" required></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Numero Documento</label><input type="text" class="form-control" id="invoice-number"></div>
                    </div>
                    <hr>
                    
                    <!-- Riga inserimento prodotti -->
                    <h5>Righe Documento</h5>
                    <div class="row align-items-end g-2 bg-light p-2 rounded">
                        <div class="col-lg-3"><label class="form-label small">Seleziona Servizio</label><select class="form-select form-select-sm" id="invoice-product-select"></select></div>
                        <div class="col-lg-3"><label class="form-label small">Descrizione</label><input type="text" class="form-control form-select-sm" id="invoice-product-description" readonly></div>
                        <div class="col-lg-1"><label class="form-label small">Qtà</label><input type="number" class="form-control form-select-sm" id="invoice-product-qty" value="1"></div>
                        <div class="col-lg-2"><label class="form-label small">Prezzo</label><input type="number" class="form-control form-select-sm" id="invoice-product-price"></div>
                        <div class="col-lg-1"><label class="form-label small">IVA</label><select class="form-select form-select-sm" id="invoice-product-iva" disabled><option value="0">0%</option><option value="22">22%</option></select></div>
                        <div class="col-lg-1 d-none" id="invoice-esenzione-iva-container"><label class="form-label small">Esenzione</label><select class="form-select form-select-sm" id="invoice-product-esenzioneIva" disabled><option value="N2.1">N2.1</option><option value="N2.2">N2.2</option><option value="N4">N4</option></select></div>
                        <div class="col-lg-1"><button type="button" class="btn btn-success w-100 btn-sm" id="add-product-to-invoice-btn"><i class="fas fa-plus"></i></button></div>
                    </div>

                    <table class="table mt-3 table-bordered table-sm">
                        <thead class="table-light"><tr><th>Descrizione</th><th class="text-end">Qtà</th><th class="text-end">Prezzo</th><th class="text-end">Totale</th><th class="text-center" style="width: 50px;">Del</th></tr></thead>
                        <tbody id="invoice-lines-tbody"></tbody>
                    </table>

                    <div class="row mt-4">
                        <div class="col-md-6 mb-3"><label class="form-label">Condizioni Pagamento</label><input type="text" class="form-control" id="invoice-condizioniPagamento"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Modalità Pagamento</label><input type="text" class="form-control" id="invoice-modalitaPagamento"></div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-3 mb-3"><label class="form-label">Data Riferimento</label><input type="date" class="form-control" id="invoice-dataRiferimento"></div>
                        <div class="col-md-2 mb-3"><label class="form-label">Giorni Scadenza</label><input type="number" class="form-control" id="invoice-giorniTermini"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Data Scadenza</label><input type="date" class="form-control" id="invoice-dataScadenza"></div>
                    </div>

                    <div class="text-end mt-3 p-3 bg-light border rounded">
                        <h4 class="mb-0">Totale Documento: <span id="invoice-total" class="text-primary">€ 0.00</span></h4>
                        <small class="text-muted" id="invoice-tax-details">(Imponibile: € 0.00)</small>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3 btn-lg w-100"><i class="fas fa-save"></i> Salva Documento</button>
                </form>
            </div>

            <!-- AZIENDA -->
            <div id="anagrafica-azienda" class="content-section d-none">
                <h2>Dati Azienda</h2>
                <form id="company-info-form">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Ragione Sociale</label><input type="text" class="form-control" id="company-name"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Cognome</label><input type="text" class="form-control" id="company-cognome"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="company-nome"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3"><label class="form-label">Indirizzo</label><input type="text" class="form-control" id="company-address"></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Civico</label><input type="text" class="form-control" id="company-numeroCivico"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Città</label><input type="text" class="form-control" id="company-city"></div>
                        <div class="col-md-2 mb-3"><label class="form-label">CAP</label><input type="text" class="form-control" id="company-zip"></div>
                        <div class="col-md-2 mb-3"><label class="form-label">Prov</label><input type="text" class="form-control" id="company-province"></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Nazione</label><input type="text" class="form-control" id="company-nazione" value="Italia"></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-3 mb-3"><label class="form-label">P.IVA</label><input type="text" class="form-control" id="company-piva"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">C.F.</label><input type="text" class="form-control" id="company-codiceFiscale"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Regime</label><input type="text" class="form-control" id="company-regimeFiscale" value="Forfettario"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Cod. Regime</label><input type="text" class="form-control" id="company-codiceRegimeFiscale" value="RF19"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3"><label class="form-label">Coeff. Redditività %</label><input type="number" class="form-control" id="company-coefficienteRedditivita"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Imposta Sostitutiva %</label><input type="number" class="form-control" id="company-aliquotaSostitutiva"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">INPS %</label><input type="number" class="form-control" id="company-aliquotaContributi"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Rivalsa INPS %</label><input type="number" class="form-control" id="company-aliquotaInps"></div>
                    </div>
                    
<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">PEC (opzionale)</label>
        <input type="email" class="form-control" id="company-pec" placeholder="nomeazienda@pec.it">
    </div>
</div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Contributi Versati (€)</label><input type="number" class="form-control" id="company-contributiVersati"></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Banca</label><input type="text" class="form-control" id="company-banca"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">IBAN</label><input type="text" class="form-control" id="company-iban"></div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save"></i> Salva Dati Azienda</button>
                </form>
            </div>

            <!-- MIGRAZIONE -->
            <div id="avanzate" class="content-section d-none">
                <h2>Migrazione Dati</h2>
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Importa Backup Vecchio</h5>
                        <p class="card-text">Carica qui il file <code>.json</code> della vecchia versione per inviare i dati al Cloud.</p>
                        <label for="import-file-input" class="btn btn-warning"><i class="fas fa-cloud-upload-alt"></i> Carica Backup JSON</label>
                        <input type="file" id="import-file-input" class="d-none" accept=".json">
                    
<hr class="my-4">
<h5 class="card-title mt-3">Backup dal Cloud (utente corrente)</h5>
<p class="card-text">
    Scarica un file <code>.json</code> con i dati attuali salvati nel Cloud
    (azienda, clienti, servizi, documenti e note) per l'utente connesso.
</p>
<button type="button" class="btn btn-success" id="export-cloud-json-btn">
    <i class="fas fa-cloud-download-alt"></i> Scarica Backup JSON
</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALE SCELTA FATTURA -->
    <div class="modal fade" id="newInvoiceChoiceModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Crea Nuova Fattura</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><button class="btn btn-primary w-100 mb-3" id="btn-create-new-blank-invoice">Crea Nuova Vuota</button><hr><div class="input-group"><select class="form-select" id="copy-from-invoice-select"><option selected>Copia da esistente...</option></select><button class="btn btn-secondary" id="btn-copy-from-invoice">Copia</button></div></div></div></div></div>

    <!-- MODALE CLIENTE (FIXED ID VISIBLE) -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="customerModalTitle">Cliente</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="customerForm">
                        <div class="mb-3 p-2 bg-light border rounded">
                            <label class="small text-muted fw-bold">ID Scheda (Sistema)</label>
                            <input type="text" class="form-control-plaintext fw-bold" id="customer-id" readonly placeholder="Nuovo (Generato al salvataggio)">
                        </div>
                        <div class="mb-3"><label class="form-label">Ragione Sociale</label><input type="text" class="form-control" id="customer-name" required></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">P.IVA</label><input type="text" class="form-control" id="customer-piva"></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Codice Fiscale</label><input type="text" class="form-control" id="customer-codiceFiscale"></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Codice S.d.I.</label><input type="text" class="form-control" id="customer-sdi"></div>
                        
<div class="mb-3">
    <label class="form-label">PEC (opzionale)</label>
    <input type="email" class="form-control" id="customer-pec" placeholder="cliente@pec.it">
</div>
                        
                        <div class="mb-3"><label class="form-label">Indirizzo</label><input type="text" class="form-control" id="customer-address"></div>
                        <div class="row">
                            <div class="col-md-5 mb-3"><label class="form-label">Città</label><input type="text" class="form-control" id="customer-comune"></div>
                            <div class="col-md-2 mb-3"><label class="form-label">Prov</label><input type="text" class="form-control" id="customer-provincia"></div>
                            <div class="col-md-2 mb-3"><label class="form-label">CAP</label><input type="text" class="form-control" id="customer-cap"></div>
                            <div class="col-md-3 mb-3"><label class="form-label">Nazione</label><input type="text" class="form-control" id="customer-nazione" value="Italia"></div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="customer-rivalsaInps">
                            <label class="form-check-label">Applica Rivalsa INPS</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="saveCustomerBtn">Salva Cliente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE PRODOTTO (FIXED ID VISIBLE) -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="productModalTitle">Servizio / Prodotto</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="mb-3 p-2 bg-light border rounded">
                            <label class="small text-muted fw-bold">ID Scheda (Sistema)</label>
                            <input type="text" class="form-control-plaintext fw-bold" id="product-id" readonly placeholder="Nuovo (Generato al salvataggio)">
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3"><label class="form-label">Descrizione</label><input type="text" class="form-control" id="product-description" required></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Codice</label><input type="text" class="form-control" id="product-code"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label class="form-label">Prezzo Vendita</label><input type="number" class="form-control" id="product-salePrice" step="0.01"></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Aliquota IVA</label><select class="form-select" id="product-iva"><option value="0">0%</option><option value="4">4%</option><option value="5">5%</option><option value="10">10%</option><option value="22">22%</option></select></div>
                            <div class="col-md-4 mb-3 d-none" id="esenzione-iva-container"><label class="form-label">Esenzione</label><select class="form-select" id="product-esenzioneIva"><option value="N2.1">N2.1</option><option value="N2.2">N2.2</option><option value="N4">N4</option></select></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Salva Servizio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE DETTAGLIO FATTURA -->
    <div class="modal fade" id="invoiceDetailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header no-print"><h5 class="modal-title" id="invoiceDetailModalTitle">Dettaglio Fattura</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="invoiceDetailModalBody"></div><div class="modal-footer no-print"><button type="button" class="btn btn-info me-auto" id="export-xml-btn"><i class="fas fa-file-code"></i> XML</button><button type="button" class="btn btn-primary" id="print-invoice-btn"><i class="fas fa-print"></i> Stampa</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button></div></div></div></div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- App Script Unico -->
    <script src="script.js"></script>
</body>
</html>