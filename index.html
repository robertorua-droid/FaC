<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Cloud - Professionisti</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Stile personalizzato -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Schermata di Login -->
    <div id="login-container" class="container">
        <div class="row justify-content-center align-items-center vh-100">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title text-center mb-4">Accesso Cloud</h3>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <div id="login-error" class="text-danger mb-3 d-none">Credenziali errate.</div>
                            <button type="submit" class="btn btn-primary w-100" id="btn-login-submit">
                                <span id="login-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                Accedi
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schermata Caricamento -->
    <div id="loading-screen" class="d-flex justify-content-center align-items-center vh-100 d-none bg-white" style="position:fixed; top:0; left:0; width:100%; z-index:2000;">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-3 lead">Sincronizzazione Cloud...</p>
        </div>
    </div>

    <!-- Applicazione Principale -->
    <div id="main-app" class="d-none">
        <div class="sidebar">
            <h4 class="text-center my-3" id="company-name-sidebar">MIO STUDIO</h4>
            <p class="text-center text-white-50 small" id="user-name-sidebar"></p>
            <p class="text-center text-white-50" style="font-size: 0.7rem;" id="version-sidebar">v9.7 (Stable Cloud)</p>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" data-target="home"><i class="fas fa-home"></i> Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-target="statistiche"><i class="fas fa-chart-line"></i> Statistiche</a></li>

                <li class="nav-item"><h6 class="nav-section-title">Anagrafiche</h6></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="anagrafica-clienti"><i class="fas fa-users"></i> Clienti</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-target="anagrafica-prodotti"><i class="fas fa-box"></i> Servizi</a></li>
                
                <li class="nav-item"><h6 class="nav-section-title">Documenti</h6></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#newInvoiceChoiceModal" id="menu-nuova-fattura"><i class="fas fa-file-invoice-dollar"></i> Nuova Fattura</a></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="nuova-fattura-accompagnatoria" id="menu-nuova-nota-credito"><i class="fas fa-file-download"></i> Nuova Nota Credito</a></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="elenco-fatture"><i class="fas fa-list-ol"></i> Elenco Documenti</a></li>
                
                <li class="nav-item"><h6 class="nav-section-title">Impostazioni</h6></li>
                <li class="nav-item menu-item"><a class="nav-link" href="#" data-target="anagrafica-azienda"><i class="fas fa-building"></i> Azienda</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-target="avanzate"><i class="fas fa-cloud-upload-alt"></i> Migrazione</a></li>

                <li class="nav-item mt-auto"><a class="nav-link" href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="main-content">
            
            <!-- HOME -->
            <div id="home" class="content-section">
                <h2 id="welcome-message">Benvenuto</h2>
                <p id="current-datetime" class="lead"></p>
                <hr>
                <div class="row mt-4">
                    <div class="col-md-6 col-lg-5 mb-4"><div id="calendar-widget"></div></div>
                    <div class="col-md-6 col-lg-5 mb-4">
                        <div id="notes-widget" class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-clipboard"></i> Block-notes Cloud</h5>
                                <textarea id="notes-textarea" class="form-control" rows="8" placeholder="Scrivi qui i tuoi appunti..."></textarea>
                                <button class="btn btn-primary btn-sm mt-2" id="save-notes-btn">Salva note</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STATISTICHE -->
            <div id="statistiche" class="content-section d-none">
                <h2>Riepilogo Fatturato</h2>
                <div id="stats-table-container"></div>
                <hr class="my-4">
                <h2>Simulazione Fiscale</h2>
                <div id="tax-simulation-container"></div>
            </div>

            <!-- CLIENTI -->
            <div id="anagrafica-clienti" class="content-section d-none">
                <h2>Anagrafica Clienti <button class="btn btn-success float-end" id="newCustomerBtn"><i class="fas fa-plus"></i> Nuovo Cliente</button></h2>
                <table class="table table-hover"><thead><tr><th>Ragione Sociale</th><th>P.IVA / C.F.</th><th>S.d.I.</th><th>Indirizzo</th><th class="text-end">Azioni</th></tr></thead><tbody id="customers-table-body"></tbody></table>
            </div>

            <!-- SERVIZI -->
            <div id="anagrafica-prodotti" class="content-section d-none">
                <h2>Anagrafica Servizi <button class="btn btn-success float-end" id="newProductBtn"><i class="fas fa-plus"></i> Nuovo Servizio</button></h2>
                <table class="table table-hover"><thead><tr><th>Codice</th><th class="col-description">Descrizione</th><th class="text-end-numbers col-price pe-5">Prezzo</th><th class="text-end-numbers">IVA</th><th class="text-end col-actions">Azioni</th></tr></thead><tbody id="products-table-body"></tbody></table>
            </div>

            <!-- ELENCO FATTURE -->
            <div id="elenco-fatture" class="content-section d-none">
                <h2>Documenti Emessi</h2>
                
<div class="mb-3 d-flex align-items-center gap-2">
    <label for="invoice-year-filter" class="form-label mb-0 me-2">Anno:</label>
    <select id="invoice-year-filter" class="form-select form-select-sm" style="width:auto; max-width:150px;">
        <option value="all">Tutti</option>
    </select>
</div>
                <table class="table table-hover"><thead><tr><th>Tipo</th><th>Numero</th><th>Data</th><th>Cliente</th><th class="text-end-numbers">Totale</th><th class="text-end-numbers">Scadenza</th><th>Stato</th><th class="text-end col-actions">Azioni</th></tr></thead><tbody id="invoices-table-body"></tbody></table>
            </div>
            
            <!-- NUOVA FATTURA / NOTA CREDITO -->
            <div id="nuova-fattura-accompagnatoria" class="content-section d-none">
                <h2 id="document-title">Nuovo Documento</h2>
                <form id="new-invoice-form">
                    <!-- ID SISTEMA VISIBILE -->
                    <div class="mb-3 p-2 bg-light border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="small text-muted fw-bold">ID Interno (Sistema)</label>
                                <input type="text" class="form-control-plaintext fw-bold" id="invoice-id" readonly placeholder="Nuovo Documento">
                            </div>
                            <div class="col-md-6">
                                <label class="small text-muted fw-bold">Tipo Documento</label>
                                <input type="text" class="form-control-plaintext" id="document-type" readonly value="Fattura">
                            </div>
                        </div>
                    </div>

                    <div id="credit-note-fields" class="row d-none bg-warning-subtle p-3 rounded mb-3 border border-warning">
                        <div class="col-md-6 mb-3"><label class="form-label">Fattura da Rettificare</label><input type="text" class="form-control" id="linked-invoice" placeholder="Es. FATT-2025-01"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Causale</label><input type="text" class="form-control" id="reason"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Cliente</label><select class="form-select" id="invoice-customer-select" required></select></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Data Documento</label><input type="date" class="form-control" id="invoice-date" required></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Numero Documento</label><input type="text" class="form-control" id="invoice-number"></div>
                    </div>
                    <hr>
                    
                    <!-- Riga inserimento prodotti -->
                    <h5>Righe Documento</h5>
                    <div class="row align-items-end g-2 bg-light p-2 rounded">
                        <div class="col-lg-3"><label class="form-label small">Seleziona Servizio</label><select class="form-select form-select-sm" id="invoice-product-select"></select></div>
                        <div class="col-lg-3"><label class="form-label small">Descrizione</label><input type="text" class="form-control form-select-sm" id="invoice-product-description" readonly></div>
                        <div class="col-lg-1"><label class="form-label small">Qtà</label><input type="number" class="form-control form-select-sm" id="invoice-product-qty" value="1"></div>
                        <div class="col-lg-2"><label class="form-label small">Prezzo</label><input type="number" class="form-control form-select-sm" id="invoice-product-price"></div>
                        <div class="col-lg-1"><label class="form-label small">IVA</label><select class="form-select form-select-sm" id="invoice-product-iva" disabled><option value="0">0%</option><option value="22">22%</option></select></div>
                        <div class="col-lg-1 d-none" id="invoice-esenzione-iva-container"><label class="form-label small">Esenzione</label><select class="form-select form-select-sm" id="invoice-product-esenzioneIva" disabled><option value="N2.1">N2.1</option><option value="N2.2">N2.2</option><option value="N4">N4</option></select></div>
                        <div class="col-lg-1"><button type="button" class="btn btn-success w-100 btn-sm" id="add-product-to-invoice-btn"><i class="fas fa-plus"></i></button></div>
                    </div>

                    <table class="table mt-3 table-bordered table-sm">
                        <thead class="table-light"><tr><th>Descrizione</th><th class="text-end">Qtà</th><th class="text-end">Prezzo</th><th class="text-end">Totale</th><th class="text-center" style="width: 50px;">Del</th></tr></thead>
                        <tbody id="invoice-lines-tbody"></tbody>
                    </table>

                    <div class="row mt-4">
                        <div class="col-md-6 mb-3"><label class="form-label">Condizioni Pagamento</label><input type="text" class="form-control" id="invoice-condizioniPagamento"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Modalità Pagamento</label><input type="text" class="form-control" id="invoice-modalitaPagamento"></div>
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-3 mb-3"><label class="form-label">Data Riferimento</label><input type="date" class="form-control" id="invoice-dataRiferimento"></div>
                        <div class="col-md-2 mb-3"><label class="form-label">Giorni Scadenza</label><input type="number" class="form-control" id="invoice-giorniTermini"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Data Scadenza</label><input type="date" class="form-control" id="invoice-dataScadenza"></div>
                    </div>

                    <div class="text-end mt-3 p-3 bg-light border rounded">
                        <h4 class="mb-0">Totale Documento: <span id="invoice-total" class="text-primary">€ 0.00</span></h4>
                        <small class="text-muted" id="invoice-tax-details">(Imponibile: € 0.00)</small>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3 btn-lg w-100"><i class="fas fa-save"></i> Salva Documento</button>
                </form>
            </div>

            <!-- AZIENDA -->
            <div id="anagrafica-azienda" class="content-section d-none">
                <h2>Dati Azienda</h2>
                <form id="company-info-form">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Ragione Sociale</label><input type="text" class="form-control" id="company-name"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Cognome</label><input type="text" class="form-control" id="company-cognome"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="company-nome"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3"><label class="form-label">Indirizzo</label><input type="text" class="form-control" id="company-address"></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Civico</label><input type="text" class="form-control" id="company-numeroCivico"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Città</label><input type="text" class="form-control" id="company-city"></div>
                        <div class="col-md-2 mb-3"><label class="form-label">CAP</label><input type="text" class="form-control" id="company-zip"></div>
                        <div class="col-md-2 mb-3"><label class="form-label">Prov</label><input type="text" class="form-control" id="company-province"></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Nazione</label><input type="text" class="form-control" id="company-nazione" value="Italia"></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-3 mb-3"><label class="form-label">P.IVA</label><input type="text" class="form-control" id="company-piva"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">C.F.</label><input type="text" class="form-control" id="company-codiceFiscale"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Regime</label><input type="text" class="form-control" id="company-regimeFiscale" value="Forfettario"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Cod. Regime</label><input type="text" class="form-control" id="company-codiceRegimeFiscale" value="RF19"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3"><label class="form-label">Coeff. Redditività %</label><input type="number" class="form-control" id="company-coefficienteRedditivita"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Imposta Sostitutiva %</label><input type="number" class="form-control" id="company-aliquotaSostitutiva"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">INPS %</label><input type="number" class="form-control" id="company-aliquotaContributi"></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Rivalsa INPS %</label><input type="number" class="form-control" id="company-aliquotaInps"></div>
                    </div>
                    
<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">PEC (opzionale)</label>
        <input type="email" class="form-control" id="company-pec" placeholder="nomeazienda@pec.it">
    </div>
</div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Contributi Versati (€)</label><input type="number" class="form-control" id="company-contributiVersati"></div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Banca</label><input type="text" class="form-control" id="company-banca"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">IBAN</label><input type="text" class="form-control" id="company-iban"></div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save"></i> Salva Dati Azienda</button>
                </form>
            </div>

            <!-- MIGRAZIONE -->
            <div id="avanzate" class="content-section d-none">
                <h2>Migrazione Dati</h2>
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Importa Backup Vecchio</h5>
                        <p class="card-text">Carica qui il file <code>.json</code> della vecchia versione per inviare i dati al Cloud.</p>
                        <label for="import-file-input" class="btn btn-warning"><i class="fas fa-cloud-upload-alt"></i> Carica Backup JSON</label>
                        <input type="file" id="import-file-input" class="d-none" accept=".json">
                    
<hr class="my-4">
<h5 class="card-title mt-3">Backup dal Cloud (utente corrente)</h5>
<p class="card-text">
    Scarica un file <code>.json</code> con i dati attuali salvati nel Cloud
    (azienda, clienti, servizi, documenti e note) per l'utente connesso.
</p>
<button type="button" class="btn btn-success" id="export-cloud-json-btn">
    <i class="fas fa-cloud-download-alt"></i> Scarica Backup JSON
</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALE SCELTA FATTURA -->
    <div class="modal fade" id="newInvoiceChoiceModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Crea Nuova Fattura</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><button class="btn btn-primary w-100 mb-3" id="btn-create-new-blank-invoice">Crea Nuova Vuota</button><hr><div class="input-group"><select class="form-select" id="copy-from-invoice-select"><option selected>Copia da esistente...</option></select><button class="btn btn-secondary" id="btn-copy-from-invoice">Copia</button></div></div></div></div></div>

    <!-- MODALE CLIENTE (FIXED ID VISIBLE) -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="customerModalTitle">Cliente</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="customerForm">
                        <div class="mb-3 p-2 bg-light border rounded">
                            <label class="small text-muted fw-bold">ID Scheda (Sistema)</label>
                            <input type="text" class="form-control-plaintext fw-bold" id="customer-id" readonly placeholder="Nuovo (Generato al salvataggio)">
                        </div>
                        <div class="mb-3"><label class="form-label">Ragione Sociale</label><input type="text" class="form-control" id="customer-name" required></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">P.IVA</label><input type="text" class="form-control" id="customer-piva"></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Codice Fiscale</label><input type="text" class="form-control" id="customer-codiceFiscale"></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Codice S.d.I.</label><input type="text" class="form-control" id="customer-sdi"></div>
                        
<div class="mb-3">
    <label class="form-label">PEC (opzionale)</label>
    <input type="email" class="form-control" id="customer-pec" placeholder="cliente@pec.it">
</div>
                        
                        <div class="mb-3"><label class="form-label">Indirizzo</label><input type="text" class="form-control" id="customer-address"></div>
                        <div class="row">
                            <div class="col-md-5 mb-3"><label class="form-label">Città</label><input type="text" class="form-control" id="customer-comune"></div>
                            <div class="col-md-2 mb-3"><label class="form-label">Prov</label><input type="text" class="form-control" id="customer-provincia"></div>
                            <div class="col-md-2 mb-3"><label class="form-label">CAP</label><input type="text" class="form-control" id="customer-cap"></div>
                            <div class="col-md-3 mb-3"><label class="form-label">Nazione</label><input type="text" class="form-control" id="customer-nazione" value="Italia"></div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="customer-rivalsaInps">
                            <label class="form-check-label">Applica Rivalsa INPS</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="saveCustomerBtn">Salva Cliente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE PRODOTTO (FIXED ID VISIBLE) -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="productModalTitle">Servizio / Prodotto</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="mb-3 p-2 bg-light border rounded">
                            <label class="small text-muted fw-bold">ID Scheda (Sistema)</label>
                            <input type="text" class="form-control-plaintext fw-bold" id="product-id" readonly placeholder="Nuovo (Generato al salvataggio)">
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3"><label class="form-label">Descrizione</label><input type="text" class="form-control" id="product-description" required></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Codice</label><input type="text" class="form-control" id="product-code"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label class="form-label">Prezzo Vendita</label><input type="number" class="form-control" id="product-salePrice" step="0.01"></div>
                            <div class="col-md-4 mb-3"><label class="form-label">Aliquota IVA</label><select class="form-select" id="product-iva"><option value="0">0%</option><option value="4">4%</option><option value="5">5%</option><option value="10">10%</option><option value="22">22%</option></select></div>
                            <div class="col-md-4 mb-3 d-none" id="esenzione-iva-container"><label class="form-label">Esenzione</label><select class="form-select" id="product-esenzioneIva"><option value="N2.1">N2.1</option><option value="N2.2">N2.2</option><option value="N4">N4</option></select></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Salva Servizio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE DETTAGLIO FATTURA -->
    <div class="modal fade" id="invoiceDetailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header no-print"><h5 class="modal-title" id="invoiceDetailModalTitle">Dettaglio Fattura</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="invoiceDetailModalBody"></div><div class="modal-footer no-print"><button type="button" class="btn btn-info me-auto" id="export-xml-btn"><i class="fas fa-file-code"></i> XML</button><button type="button" class="btn btn-primary" id="print-invoice-btn"><i class="fas fa-print"></i> Stampa</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button></div></div></div></div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- App Script Unico -->
    <script src="script.js"></script>
</body>
</html>

--- START OF FILE script.js ---

// CONFIGURAZIONE FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCuGd5MSKdixcMYOYullnyam6Pj1D9tNbM",
  authDomain: "fprf-6c080.firebaseapp.com",
  projectId: "fprf-6c080",
  storageBucket: "fprf-6c080.firebasestorage.app",
  messagingSenderId: "406236428222",
  appId: "1:406236428222:web:3be6b3b8530ab20ba36bef"
};

// Inizializza Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Variabili Globali
let globalData = {
    companyInfo: {},
    products: [],
    customers: [],
    invoices: [],
    notes: []
};

let currentUser = null;
let dateTimeInterval = null;

$(document).ready(function() {

    // =========================================================
    // 1. FUNZIONI DI UTILITÀ
    // =========================================================

    function formatDateForDisplay(dateString) {
        if (!dateString) return '-';
        const parts = dateString.split('-');
        if (parts.length !== 3) return dateString; 
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    function escapeXML(str) { 
        if (typeof str !== 'string') return ''; 
        return str.replace(/[<>&'"]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '\'': '&apos;', '"': '&quot;' })[c]); 
    }

    function getNextId(items) { 
        if (!items || items.length === 0) return 1;
        const numericIds = items.map(i => parseInt(i.id)).filter(id => !isNaN(id));
        return numericIds.length > 0 ? Math.max(...numericIds) + 1 : 1; 
    }

    function getData(key) {
        return globalData[key] || [];
    }

    function safeFloat(val) { const n = parseFloat(val); return isNaN(n) ? 0 : n; }

    // =========================================================
    // 2. GESTIONE DATI CLOUD
    // =========================================================

    async function loadAllDataFromCloud() {
        try {
            const companyDoc = await db.collection('settings').doc('companyInfo').get();
            if (companyDoc.exists) globalData.companyInfo = companyDoc.data();

            const collections = ['products', 'customers', 'invoices', 'notes'];
            for (const col of collections) {
                const snapshot = await db.collection(col).get();
                globalData[col] = snapshot.docs.map(doc => ({ id: String(doc.id), ...doc.data() }));
            }
            console.log("Dati sincronizzati:", globalData);
        } catch (e) { console.error("Errore Load Cloud:", e); }
    }

    async function saveDataToCloud(collection, dataObj, id = null) {
        try {
            if (collection === 'companyInfo') {
                await db.collection('settings').doc('companyInfo').set(dataObj);
                globalData.companyInfo = dataObj;
            } else {
                if (id) {
                    const strId = String(id);
                    await db.collection(collection).doc(strId).set(dataObj, { merge: true });
                    const index = globalData[collection].findIndex(item => String(item.id) === strId);
                    if (index > -1) globalData[collection][index] = { ...globalData[collection][index], ...dataObj };
                    else globalData[collection].push({ id: strId, ...dataObj });
                } else { console.error("ID mancante"); }
            }
        } catch (e) { alert("Errore Cloud: " + e.message); }
    }

    async function deleteDataFromCloud(collection, id) {
        if (confirm("Sei sicuro di voler eliminare questo elemento?")) {
            try {
                const strId = String(id);
                await db.collection(collection).doc(strId).delete();
                globalData[collection] = globalData[collection].filter(item => String(item.id) !== strId);
                renderAll();
            } catch (e) { alert("Errore eliminazione: " + e.message); }
        }
    }

    // =========================================================
    // 3. FUNZIONI DI RENDER UI
    // =========================================================

    function renderAll() {
        renderCompanyInfoForm(); 
        updateCompanyUI(); 
        renderProductsTable(); 
        renderCustomersTable(); 
        renderInvoicesTable();
        populateDropdowns(); 
        renderStatisticsPage(); 
        renderHomePage();
    }

    function updateCompanyUI() { 
        const company = getData('companyInfo'); 
        if(company.name) $('#company-name-sidebar').text(company.name);
        if(currentUser && currentUser.email) $('#user-name-sidebar').text(currentUser.email);
    }

    function renderHomePage() { 
        if(currentUser) $('#welcome-message').text(`Benvenuto, ${currentUser.email}`); 
        const note = getData('notes').find(n => n.userId === currentUser.uid);
        if(note) $('#notes-textarea').val(note.text);
        renderCalendar();
        if (dateTimeInterval) clearInterval(dateTimeInterval);
        const updateDateTime = () => $('#current-datetime').text(new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }));
        updateDateTime();
        dateTimeInterval = setInterval(updateDateTime, 1000);
    }

    function renderCalendar() {
        const c = $('#calendar-widget');
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const todayDate = now.getDate();
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const totalDays = lastDay.getDate();
        let startingDay = firstDay.getDay(); 
        
        let html = `<div class="card shadow-sm border-0"><div class="card-header bg-primary text-white text-center fw-bold">${firstDay.toLocaleDateString('it-IT',{month:'long',year:'numeric'}).toUpperCase()}</div><div class="card-body p-0"><table class="table table-bordered text-center mb-0" style="table-layout: fixed;"><thead class="table-light"><tr><th class="text-danger">Dom</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Gio</th><th>Ven</th><th>Sab</th></tr></thead><tbody><tr>`;
        for(let i = 0; i < startingDay; i++) { html += '<td class="bg-light"></td>'; }
        for(let day = 1; day <= totalDays; day++) {
            if (startingDay > 6) { startingDay = 0; html += '</tr><tr>'; }
            const isToday = (day === todayDate) ? 'bg-primary text-white fw-bold rounded-circle' : '';
            html += `<td class="align-middle p-2"><div class="${isToday}" style="width:32px; height:32px; line-height:32px; margin:0 auto;">${day}</div></td>`;
            startingDay++;
        }
        while(startingDay <= 6) { html += '<td class="bg-light"></td>'; startingDay++; }
        html += '</tr></tbody></table></div></div>';
        c.html(html);
    }

    function renderStatisticsPage() {
        const container = $('#stats-table-container').empty();
        const facts = getData('invoices').filter(i => i.type === 'Fattura' || i.type === undefined || i.type === '');
        const notes = getData('invoices').filter(i => i.type === 'Nota di Credito');
        
        if(facts.length === 0) { container.html('<div class="alert alert-info">Nessun dato.</div>'); renderTaxSimulation(0,0); return; }

        const totF = facts.reduce((s,i)=>s+safeFloat(i.total),0);
        const totN = notes.reduce((s,i)=>s+safeFloat(i.total),0);
        const net = totF - totN;

        let cust = {};
        facts.forEach(i=>{const c=String(i.customerId); if(!cust[c])cust[c]=0; cust[c]+=safeFloat(i.total)});
        notes.forEach(i=>{const c=String(i.customerId); if(cust[c])cust[c]-=safeFloat(i.total)});

        let h = `<div class="card shadow-sm mb-4 border-0"><div class="card-header fw-bold bg-white border-bottom">Dettaglio Clienti</div><div class="card-body p-0"><table class="table table-striped mb-0 table-hover"><thead><tr><th>Cliente</th><th class="text-end">Fatturato Netto</th><th class="text-end">% sul Totale</th></tr></thead><tbody>`;
        Object.keys(cust).sort((a,b)=>cust[b]-cust[a]).forEach(cid=>{
            const c = getData('customers').find(x=>String(x.id)===String(cid))||{name:'?'};
            const tot = cust[cid];
            const perc = net > 0 ? (tot / net) * 100 : 0;
            h+=`<tr><td>${c.name}</td><td class="text-end">€ ${tot.toFixed(2)}</td><td class="text-end">${perc.toFixed(1)}%</td></tr>`;
        });
        h+=`</tbody><tfoot class="table-dark"><tr><td>TOTALE</td><td class="text-end">€ ${net.toFixed(2)}</td><td class="text-end">100%</td></tr></tfoot></table></div></div>`;
        container.html(h);
        
        const impF = facts.reduce((s,i)=>s+safeFloat(i.totaleImponibile||i.total),0);
        const impN = notes.reduce((s,i)=>s+safeFloat(i.totaleImponibile||i.total),0);
        renderTaxSimulation(impF, impN);
    }

    function renderTaxSimulation(fatturatoImponibile, noteCreditoImponibile) {
        const container = $('#tax-simulation-container').empty();
        const comp = getData('companyInfo');
        const coeff = safeFloat(comp.coefficienteRedditivita);
        const taxRate = safeFloat(comp.aliquotaSostitutiva);
        const inpsRate = safeFloat(comp.aliquotaContributi);

        if(!coeff || !taxRate || !inpsRate) { container.html('<div class="alert alert-warning">Dati mancanti.</div>'); return; }

        const grossRevenue = fatturatoImponibile - noteCreditoImponibile;
        const taxableIncome = grossRevenue * (coeff / 100);
        const socialSecurity = taxableIncome * (inpsRate / 100);
        const netTaxable = taxableIncome - socialSecurity;
        const tax = (netTaxable > 0) ? netTaxable * (taxRate / 100) : 0;
        const totalDue = socialSecurity + tax;

        const html = `
            <div class="row">
                <div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-header fw-bold">Simulazione Contributi INPS</div><div class="card-body"><dl class="row mb-0">
                    <dt class="col-sm-8">Reddito Lordo Imponibile</dt><dd class="col-sm-4 text-end">€ ${taxableIncome.toFixed(2)}</dd>
                    <dt class="col-sm-8">Aliquota Contributi INPS</dt><dd class="col-sm-4 text-end">${inpsRate}%</dd>
                    <dt class="col-sm-8 h5 text-primary border-top pt-3">Contributi Totali Previsti</dt><dd class="col-sm-4 text-end h5 text-primary border-top pt-3">€ ${socialSecurity.toFixed(2)}</dd>
                    <hr class="my-3"><dt class="col-sm-8 fw-normal">Stima Primo Acconto (40%)</dt><dd class="col-sm-4 text-end text-muted">€ ${(socialSecurity*0.4).toFixed(2)}</dd>
                    <dt class="col-sm-8 fw-normal">Stima Secondo Acconto (40%)</dt><dd class="col-sm-4 text-end text-muted">€ ${(socialSecurity*0.4).toFixed(2)}</dd>
                </dl></div></div></div>
                <div class="col-lg-6 mb-4"><div class="card h-100"><div class="card-header fw-bold">Simulazione Imposta Sostitutiva (IRPEF)</div><div class="card-body"><dl class="row mb-0">
                    <dt class="col-sm-8">Reddito Lordo Imponibile</dt><dd class="col-sm-4 text-end">€ ${taxableIncome.toFixed(2)}</dd>
                    <dt class="col-sm-8">Contributi INPS Deducibili</dt><dd class="col-sm-4 text-end text-danger">- € ${socialSecurity.toFixed(2)}</dd>
                    <dt class="col-sm-8 border-top pt-2">Reddito Netto Imponibile</dt><dd class="col-sm-4 text-end border-top pt-2">€ ${netTaxable.toFixed(2)}</dd>
                    <dt class="col-sm-8">Aliquota Imposta</dt><dd class="col-sm-4 text-end">${taxRate}%</dd>
                    <dt class="col-sm-8 h5 text-primary border-top pt-3">Imposta Totale Prevista</dt><dd class="col-sm-4 text-end h5 text-primary border-top pt-3">€ ${tax.toFixed(2)}</dd>
                    <hr class="my-3"><dt class="col-sm-8 fw-normal">Stima Primo Acconto (50%)</dt><dd class="col-sm-4 text-end text-muted">€ ${(tax*0.5).toFixed(2)}</dd>
                    <dt class="col-sm-8 fw-normal">Stima Secondo Acconto (50%)</dt><dd class="col-sm-4 text-end text-muted">€ ${(tax*0.5).toFixed(2)}</dd>
                </dl></div></div></div>
            </div>
            <div class="card bg-light mt-4"><div class="card-body d-flex justify-content-between align-items-center"><h5 class="card-title mb-0">Totale Uscite Stimate (Contributi + Imposte)</h5><h5 class="card-title mb-0">€ ${totalDue.toFixed(2)}</h5></div></div>`;
        container.html(html);
    }

    function renderCompanyInfoForm() { const c = getData('companyInfo'); for (const k in c) $(`#company-${k}`).val(c[k]); }
    
    function renderProductsTable() { 
        const table = $('#products-table-body').empty(); 
        getData('products').forEach(p => { 
            const price = parseFloat(p.salePrice).toFixed(2);
            table.append(`<tr><td>${p.code}</td><td>${p.description}</td><td class="text-end">€ ${price}</td><td class="text-end">${p.iva}%</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-product" data-id="${p.id}"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-outline-danger btn-delete-product" data-id="${p.id}"><i class="fas fa-trash"></i></button></td></tr>`); 
        }); 
    }
    
    function renderCustomersTable() { 
        const table = $('#customers-table-body').empty(); 
        getData('customers').forEach(c => { 
            table.append(`<tr><td>${c.name}</td><td>${c.piva}</td><td>${c.sdi || '-'}</td><td>${c.address || ''}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-customer" data-id="${c.id}"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-outline-danger btn-delete-customer" data-id="${c.id}"><i class="fas fa-trash"></i></button></td></tr>`); 
        }); 
    }
    
    function renderInvoicesTable() {
        const table = $('#invoices-table-body').empty();
        const invoices = getData('invoices').sort((a, b) => (b.number || '').localeCompare(a.number || ''));
        
        invoices.forEach(inv => {
            const c = getData('customers').find(cust => String(cust.id) === String(inv.customerId)) || { name: 'Sconosciuto' }; 
            const isPaid = inv.status === 'Pagata' || inv.status === 'Emessa';
            
            const badge = inv.type === 'Nota di Credito' ? '<span class="badge bg-warning text-dark border border-dark">NdC</span>' : '<span class="badge bg-primary">Fatt.</span>';
            let statusBadge = '<span class="badge bg-warning text-dark">Da Incassare</span>';
            if (inv.type === 'Nota di Credito') statusBadge = isPaid ? '<span class="badge bg-info text-dark">Emessa</span>' : '<span class="badge bg-secondary">Bozza</span>';
            else statusBadge = isPaid ? '<span class="badge bg-success">Pagata</span>' : '<span class="badge bg-warning text-dark">Da Incassare</span>';
            
            const payClass = isPaid ? 'btn-secondary disabled' : 'btn-success';
            const editClass = isPaid ? 'btn-secondary disabled' : 'btn-outline-secondary';
            const btnDelete = `<button class="btn btn-sm btn-danger btn-delete-invoice" data-id="${inv.id}" title="Elimina"><i class="fas fa-trash"></i></button>`;

            const btns = `<div class="d-flex justify-content-end gap-1"><button class="btn btn-sm btn-info btn-view-invoice text-white" data-id="${inv.id}" data-bs-toggle="modal" data-bs-target="#invoiceDetailModal" title="Vedi"><i class="fas fa-eye"></i></button><button class="btn btn-sm ${editClass} btn-edit-invoice" data-id="${inv.id}" title="Modifica" ${isPaid?'disabled':''}><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-warning btn-export-xml-row" data-id="${inv.id}" title="XML"><i class="fas fa-file-code"></i></button><button class="btn btn-sm ${payClass} btn-mark-paid" data-id="${inv.id}" title="Stato" ${isPaid?'disabled':''}><i class="fas fa-check"></i></button>${btnDelete}</div>`;
            const total = (parseFloat(inv.total) || 0).toFixed(2);
            table.append(`<tr class="${isPaid?'table-light text-muted':''}"><td>${badge}</td><td class="fw-bold">${inv.number}</td><td>${formatDateForDisplay(inv.date)}</td><td>${c.name}</td><td class="text-end">€ ${total}</td><td class="text-end small">${formatDateForDisplay(inv.dataScadenza)}</td><td>${statusBadge}</td><td class="text-end">${btns}</td></tr>`);
        });
    }

    function populateDropdowns() {
        $('#invoice-customer-select').empty().append('<option selected disabled value="">Seleziona...</option>').append(getData('customers').map(c => `<option value="${c.id}">${c.name}</option>`));
        $('#invoice-product-select').empty().append('<option selected value="">Seleziona...</option><option value="manual">Manuale</option>').append(getData('products').map(p => `<option value="${p.id}">${p.code} - ${p.description}</option>`));
    }

    // =========================================================
    // 4. EVENT LISTENERS
    // =========================================================

    // AUTH
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            $('#login-container').addClass('d-none'); $('#loading-screen').removeClass('d-none'); 
            try {
                await loadAllDataFromCloud(); 
                $('#loading-screen').addClass('d-none'); $('#main-app').removeClass('d-none');
                initializeApp();
            } catch (error) { alert("Errore DB: " + error.message); $('#loading-screen').addClass('d-none'); }
        } else {
            currentUser = null;
            $('#main-app').addClass('d-none'); $('#loading-screen').addClass('d-none'); $('#login-container').removeClass('d-none');
        }
    });

    $('#login-form').on('submit', function(e) {
        e.preventDefault();
        auth.signInWithEmailAndPassword($('#email').val(), $('#password').val()).catch(err => { $('#login-error').removeClass('d-none'); });
    });

    $('#logout-btn').on('click', function(e) { e.preventDefault(); auth.signOut().then(() => location.reload()); });

    // NAVIGAZIONE
    $('.sidebar .nav-link').on('click', function(e) {
        if(this.id === 'logout-btn' || this.getAttribute('data-bs-toggle')) return;
        e.preventDefault();
        const target = $(this).data('target');

        if(target === 'nuova-fattura-accompagnatoria') {
            if(this.id === 'menu-nuova-nota-credito') prepareDocumentForm('Nota di Credito');
            else if(this.id === 'menu-nuova-fattura') return; 
            else prepareDocumentForm('Fattura');
        }
        
        if(target === 'statistiche') renderStatisticsPage();
        $('.sidebar .nav-link').removeClass('active'); $(this).addClass('active');
        $('.content-section').addClass('d-none'); $('#' + target).removeClass('d-none');
    });

    // MODALE FATTURA
    $('#newInvoiceChoiceModal').on('show.bs.modal', function () {
        const invoices = getData('invoices').filter(i => i.type === 'Fattura' || i.type === undefined);
        invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
        const options = invoices.map(inv => `<option value="${inv.id}">${inv.number} - ${formatDateForDisplay(inv.date)}</option>`).join('');
        $('#copy-from-invoice-select').html('<option selected value="">Copia da esistente...</option>' + options);
    });

    $('#btn-create-new-blank-invoice').click(function() {
        $('#newInvoiceChoiceModal').modal('hide');
        $('.sidebar .nav-link').removeClass('active'); $('[data-bs-target="#newInvoiceChoiceModal"]').addClass('active');
        $('.content-section').addClass('d-none'); $('#nuova-fattura-accompagnatoria').removeClass('d-none');
        prepareDocumentForm('Fattura');
    });

    $('#btn-copy-from-invoice').click(function() {
        const id = $('#copy-from-invoice-select').val();
        if(!id) return;
        $('#newInvoiceChoiceModal').modal('hide');
        $('.sidebar .nav-link').removeClass('active'); $('[data-bs-target="#newInvoiceChoiceModal"]').addClass('active');
        $('.content-section').addClass('d-none'); $('#nuova-fattura-accompagnatoria').removeClass('d-none');
        loadInvoiceForEditing(id, true);
    });

    // CRUD ANAGRAFICHE (Con ID sicuro)
    function editItem(type, id) { 
        if (type === 'customer' || type === 'product') CURRENT_EDITING_ID = String(id);
        const item = getData(`${type}s`).find(i => String(i.id) === String(id)); 
        if (!item) return; 
        $(`#${type}Form`)[0].reset(); $(`#${type}ModalTitle`).text(`Modifica`); 
        $(`#${type}-id`).val(String(item.id));
        for (const key in item) { 
            const field = $(`#${type}-${key}`); 
            if (field.length) { if (field.is(':checkbox')) field.prop('checked', item[key]); else field.val(item[key]); }
        } 
        if (type === 'product') { $('#product-iva').trigger('change'); if(item.iva == '0') $('#product-esenzioneIva').val(item.esenzioneIva); } 
        $(`#${type}Modal`).modal('show'); 
    }

    $('#newCustomerBtn').click(() => { CURRENT_EDITING_ID = null; $('#customerForm')[0].reset(); $('#customer-id').val('Nuovo'); $('#customerModal').modal('show'); });
    $('#saveCustomerBtn').click(async () => {
        const data = {
            name: $('#customer-name').val(), piva: $('#customer-piva').val(), codiceFiscale: $('#customer-codiceFiscale').val(),
            sdi: $('#customer-sdi').val(), address: $('#customer-address').val(), comune: $('#customer-comune').val(),
            provincia: $('#customer-provincia').val(), cap: $('#customer-cap').val(), nazione: $('#customer-nazione').val(),
            rivalsaInps: $('#customer-rivalsaInps').is(':checked')
        };
        let id = CURRENT_EDITING_ID ? CURRENT_EDITING_ID : String(getNextId(getData('customers')));
        await saveDataToCloud('customers', data, id); $('#customerModal').modal('hide'); renderAll();
    });
    $('#customers-table-body').on('click', '.btn-edit-customer', function(e) { editItem('customer', $(e.currentTarget).attr('data-id')); });
    $('#customers-table-body').on('click', '.btn-delete-customer', function(e) { deleteDataFromCloud('customers', $(e.currentTarget).attr('data-id')); });

    $('#newProductBtn').click(() => { CURRENT_EDITING_ID = null; $('#productForm')[0].reset(); $('#product-id').val('Nuovo'); $('#product-iva').val('0').change(); $('#productModal').modal('show'); });
    $('#saveProductBtn').click(async () => {
        const data = {
            description: $('#product-description').val(), code: $('#product-code').val(),
            salePrice: $('#product-salePrice').val(), iva: $('#product-iva').val(), esenzioneIva: $('#product-esenzioneIva').val()
        };
        let id = CURRENT_EDITING_ID ? CURRENT_EDITING_ID : 'PRD' + new Date().getTime();
        await saveDataToCloud('products', data, id); $('#productModal').modal('hide'); renderAll();
    });
    $('#products-table-body').on('click', '.btn-edit-product', function(e) { editItem('product', $(e.currentTarget).attr('data-id')); });
    $('#products-table-body').on('click', '.btn-delete-product', function(e) { deleteDataFromCloud('products', $(e.currentTarget).attr('data-id')); });
    $('#product-iva').change(function() { toggleEsenzioneIvaField('product', $(this).val()); });

    // FATTURE CORE
    window.tempInvoiceLines = []; 
    let CURRENT_EDITING_ID = null;
    let CURRENT_EDITING_INVOICE_ID = null;

    function prepareDocumentForm(type) {
        CURRENT_EDITING_INVOICE_ID = null; 
        $('#new-invoice-form')[0].reset(); $('#invoice-id').val('Nuovo'); $('#document-type').val(type);
        $('#invoice-lines-tbody').empty(); window.tempInvoiceLines = []; populateDropdowns();
        const today = new Date().toISOString().slice(0, 10); $('#invoice-date').val(today);
        if (type === 'Nota di Credito') { $('#document-title').text('Nuova Nota di Credito'); $('#credit-note-fields').removeClass('d-none'); } else { $('#document-title').text('Nuova Fattura'); $('#credit-note-fields').addClass('d-none'); }
        updateInvoiceNumber(type, today.substring(0, 4)); updateTotalsDisplay();
    }

    function loadInvoiceForEditing(id, isCopy) {
        const inv = getData('invoices').find(i => String(i.id) === String(id)); if (!inv) return;
        const type = isCopy ? 'Fattura' : (inv.type || 'Fattura');
        prepareDocumentForm(type);
        if (!isCopy) { CURRENT_EDITING_INVOICE_ID = String(inv.id); $('#invoice-id').val(inv.id); $('#document-title').text(`Modifica ${type} ${inv.number}`); }
        $('#invoice-customer-select').val(inv.customerId);
        $('#invoice-date').val(isCopy ? new Date().toISOString().slice(0, 10) : inv.date);
        if(!isCopy) $('#invoice-number').val(inv.number);
        $('#invoice-condizioniPagamento').val(inv.condizioniPagamento); $('#invoice-modalitaPagamento').val(inv.modalitaPagamento); $('#invoice-dataScadenza').val(inv.dataScadenza);
        if (type === 'Nota di Credito') { $('#linked-invoice').val(inv.linkedInvoice); $('#reason').val(inv.reason); }
        window.tempInvoiceLines = JSON.parse(JSON.stringify(inv.lines)); renderLocalInvoiceLines(); updateTotalsDisplay();
    }

    function updateInvoiceNumber(type, year) {
        if (CURRENT_EDITING_INVOICE_ID) return;
        const invs = getData('invoices').filter(i => (i.type === type || (type==='Fattura' && !i.type)) && i.date.substring(0, 4) === String(year));
        let next = 1; if (invs.length > 0) next = Math.max(...invs.map(i => parseInt(i.number.split('-').pop()) || 0)) + 1;
        $('#invoice-number').val(`${type==='Fattura'?'FATT':'NC'}-${year}-${String(next).padStart(2, '0')}`);
    }

    $('#add-product-to-invoice-btn').click(() => {
        const d = $('#invoice-product-description').val(); if(!d) return;
        window.tempInvoiceLines.push({ productName: d, qty: parseFloat($('#invoice-product-qty').val())||1, price: parseFloat($('#invoice-product-price').val())||0, subtotal: (parseFloat($('#invoice-product-qty').val())||1)*(parseFloat($('#invoice-product-price').val())||0), iva: $('#invoice-product-iva').val(), esenzioneIva: $('#invoice-product-esenzioneIva').val() });
        renderLocalInvoiceLines(); updateTotalsDisplay();
    });

    function renderLocalInvoiceLines() {
        const t = $('#invoice-lines-tbody').empty(); 
        window.tempInvoiceLines.forEach((l, i) => { t.append(`<tr><td>${l.productName}</td><td class="text-end">${l.qty}</td><td class="text-end">€ ${l.price.toFixed(2)}</td><td class="text-end">€ ${l.subtotal.toFixed(2)}</td><td class="text-center"><button type="button" class="btn btn-sm btn-danger del-line" data-i="${i}"><i class="fas fa-times"></i></button></td></tr>`); });
    }
    $('#invoice-lines-tbody').on('click', '.del-line', function() { window.tempInvoiceLines.splice($(this).data('i'), 1); renderLocalInvoiceLines(); updateTotalsDisplay(); });

    function updateTotalsDisplay() {
        const cid = $('#invoice-customer-select').val(); const cust = getData('customers').find(c => String(c.id) === String(cid)); const comp = getData('companyInfo');
        const rows = window.tempInvoiceLines.filter(l => l.productName.toLowerCase() !== 'rivalsa bollo');
        const bollo = window.tempInvoiceLines.find(l => l.productName.toLowerCase() === 'rivalsa bollo');
        const impBollo = bollo ? bollo.subtotal : 0;
        const totPrest = rows.reduce((s, l) => s + l.subtotal, 0);
        let riv = 0; if (cust && cust.rivalsaInps) riv = totPrest * (parseFloat(comp.aliquotaInps||0) / 100);
        const totDoc = totPrest + riv + impBollo;
        $('#invoice-total').text(`€ ${totDoc.toFixed(2)}`);
        $('#invoice-tax-details').text(`(Imp: € ${(totPrest+riv).toFixed(2)} - Bollo: € ${impBollo.toFixed(2)})`);
        return { totPrest, riv, impBollo, totImp: totPrest+riv, totDoc };
    }
    $('#invoice-customer-select').change(updateTotalsDisplay);

    $('#new-invoice-form').submit(async function(e) {
        e.preventDefault();
        const cid = $('#invoice-customer-select').val(); if (!cid || window.tempInvoiceLines.length === 0) { alert("Dati incompleti."); return; }
        const type = $('#document-type').val(); const calcs = updateTotalsDisplay();
        const data = {
            number: $('#invoice-number').val(), date: $('#invoice-date').val(), customerId: cid, type: type, lines: window.tempInvoiceLines,
            totalePrestazioni: calcs.totPrest, importoBollo: calcs.impBollo, rivalsa: { importo: calcs.riv }, totaleImponibile: calcs.totImp, total: calcs.totDoc,
            status: (type === 'Fattura' ? 'Da Incassare' : 'Emessa'), dataScadenza: $('#invoice-dataScadenza').val(),
            condizioniPagamento: $('#invoice-condizioniPagamento').val(), modalitaPagamento: $('#invoice-modalitaPagamento').val(),
            linkedInvoice: $('#linked-invoice').val(), reason: $('#reason').val()
        };
        if (CURRENT_EDITING_INVOICE_ID) { const old = getData('invoices').find(i => String(i.id) === CURRENT_EDITING_INVOICE_ID); if(old) data.status = old.status; }
        let id = CURRENT_EDITING_INVOICE_ID ? CURRENT_EDITING_INVOICE_ID : String(getNextId(getData('invoices')));
        await saveDataToCloud('invoices', data, id); alert("Salvato!"); $('.sidebar .nav-link[data-target="elenco-fatture"]').click();
    });

    $('#invoices-table-body').on('click', '.btn-edit-invoice', function() { loadInvoiceForEditing($(this).attr('data-id'), false); });
    $('#invoices-table-body').on('click', '.btn-delete-invoice', function() { deleteDataFromCloud('invoices', $(this).attr('data-id')); });
    $('#invoices-table-body').on('click', '.btn-mark-paid', async function() { 
        const id = $(this).attr('data-id'); const inv = getData('invoices').find(i => String(i.id) === String(id));
        if(confirm("Confermi cambio stato?")) { await saveDataToCloud('invoices', { status: inv.type === 'Nota di Credito' ? 'Emessa' : 'Pagata' }, id); renderInvoicesTable(); }
    });

    // XML
    $('#invoices-table-body, #invoiceDetailModal').on('click', '.btn-export-xml, #export-xml-btn, .btn-export-xml-row', function() { 
         let id = $(this).attr('id') === 'export-xml-btn' ? $('#export-xml-btn').data('invoiceId') : $(this).attr('data-id');
         if (id) generateInvoiceXML(id); 
    });
    function generateInvoiceXML(invoiceId) {
        const invoice = getData('invoices').find(inv => String(inv.id) === String(invoiceId)); if (!invoice) { alert("Errore!"); return; }
        const company = getData('companyInfo'); const customer = getData('customers').find(c => String(c.id) === String(invoice.customerId));
        let anagraficaCedente = `<Anagrafica><Denominazione>${escapeXML(company.name)}</Denominazione></Anagrafica>`;
        if (company.nome && company.cognome) { anagraficaCedente = `<Anagrafica><Nome>${escapeXML(company.nome)}</Nome><Cognome>${escapeXML(company.cognome)}</Cognome></Anagrafica>`; }
        const summaryByNature = {}; invoice.lines.forEach(l => { if (l.iva == "0" && l.esenzioneIva) { const k = l.esenzioneIva; if (!summaryByNature[k]) summaryByNature[k] = { aliquota: l.iva, natura: k, imponibile: 0 }; summaryByNature[k].imponibile += l.subtotal; } });
        if (invoice.rivalsa && invoice.rivalsa.importo > 0) { const k = "N4"; if (!summaryByNature[k]) summaryByNature[k] = { aliquota: "0.00", natura: k, imponibile: 0 }; summaryByNature[k].imponibile += invoice.rivalsa.importo; }
        let riepilogoXml = ''; Object.values(summaryByNature).forEach(s => { riepilogoXml += `<DatiRiepilogo><AliquotaIVA>${parseFloat(s.aliquota).toFixed(2)}</AliquotaIVA><Natura>${escapeXML(s.natura)}</Natura><ImponibileImporto>${s.imponibile.toFixed(2)}</ImponibileImporto><Imposta>0.00</Imposta></DatiRiepilogo>`; });
        let xml = `<?xml version="1.0" encoding="UTF-8"?><p:FatturaElettronica versione="FPR12" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:p="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><FatturaElettronicaHeader><DatiTrasmissione><IdTrasmittente><IdPaese>IT</IdPaese><IdCodice>${escapeXML(company.codiceFiscale)}</IdCodice></IdTrasmittente><ProgressivoInvio>${(Math.random().toString(36)+'00000').slice(2,7)}</ProgressivoInvio><FormatoTrasmissione>FPR12</FormatoTrasmissione><CodiceDestinatario>${escapeXML(customer.sdi||'0000000')}</CodiceDestinatario></DatiTrasmissione><CedentePrestatore><DatiAnagrafici><IdFiscaleIVA><IdPaese>IT</IdPaese><IdCodice>${escapeXML(company.piva)}</IdCodice></IdFiscaleIVA><CodiceFiscale>${escapeXML(company.codiceFiscale)}</CodiceFiscale>${anagraficaCedente}<RegimeFiscale>${escapeXML(company.codiceRegimeFiscale)}</RegimeFiscale></DatiAnagrafici><Sede><Indirizzo>${escapeXML(company.address)}</Indirizzo><NumeroCivico>${escapeXML(company.numeroCivico)}</NumeroCivico><CAP>${escapeXML(company.zip)}</CAP><Comune>${escapeXML(company.city)}</Comune><Provincia>${escapeXML(company.province)}</Provincia><Nazione>IT</Nazione></Sede></CedentePrestatore><CessionarioCommittente><DatiAnagrafici><IdFiscaleIVA><IdPaese>IT</IdPaese><IdCodice>${escapeXML(customer.piva)}</IdCodice></IdFiscaleIVA><CodiceFiscale>${escapeXML(customer.codiceFiscale)}</CodiceFiscale><Anagrafica><Denominazione>${escapeXML(customer.name)}</Denominazione></Anagrafica></DatiAnagrafici><Sede><Indirizzo>${escapeXML(customer.address)}</Indirizzo><CAP>${escapeXML(customer.cap)}</CAP><Comune>${escapeXML(customer.comune)}</Comune><Provincia>${escapeXML(customer.provincia)}</Provincia><Nazione>IT</Nazione></Sede></CessionarioCommittente></FatturaElettronicaHeader><FatturaElettronicaBody><DatiGenerali><DatiGeneraliDocumento><TipoDocumento>${invoice.type==='Nota di Credito'?'TD04':'TD01'}</TipoDocumento><Divisa>EUR</Divisa><Data>${invoice.date}</Data><Numero>${escapeXML(invoice.number)}</Numero><ImportoTotaleDocumento>${invoice.total.toFixed(2)}</ImportoTotaleDocumento>${invoice.type==='Nota di Credito'?`<Causale>${escapeXML(invoice.reason)}</Causale>`:''}</DatiGeneraliDocumento></DatiGenerali><DatiBeniServizi>`;
        let ln = 1; invoice.lines.forEach(l => { xml += `<DettaglioLinee><NumeroLinea>${ln++}</NumeroLinea><Descrizione>${escapeXML(l.productName)}</Descrizione><Quantita>${l.qty.toFixed(2)}</Quantita><PrezzoUnitario>${l.price.toFixed(2)}</PrezzoUnitario><PrezzoTotale>${l.subtotal.toFixed(2)}</PrezzoTotale><AliquotaIVA>${parseFloat(l.iva).toFixed(2)}</AliquotaIVA><Natura>${escapeXML(l.esenzioneIva)}</Natura></DettaglioLinee>`; });
        xml += `${riepilogoXml}</DatiBeniServizi><DatiPagamento><CondizioniPagamento>TP02</CondizioniPagamento><DettaglioPagamento><ModalitaPagamento>MP05</ModalitaPagamento><DataScadenzaPagamento>${invoice.dataScadenza}</DataScadenzaPagamento><ImportoPagamento>${invoice.total.toFixed(2)}</ImportoPagamento><IBAN>${escapeXML(company.iban)}</IBAN></DettaglioPagamento></DatiPagamento></FatturaElettronicaBody></p:FatturaElettronica>`;
        const a = document.createElement('a'); a.download = `IT${company.piva}_XML.xml`; const b = new Blob([xml], { type: 'application/xml' }); a.href = URL.createObjectURL(b); a.click();
    }
    // VIEW
    $('#invoices-table-body').on('click', '.btn-view-invoice', function() {
        const id = $(this).attr('data-id'); const inv = getData('invoices').find(i=>String(i.id)===String(id)); if(!inv) return;
        const c = getData('customers').find(x=>String(x.id)===String(inv.customerId))||{};
        $('#export-xml-btn').data('invoiceId', inv.id); $('#invoiceDetailModalTitle').text(`${inv.type} ${inv.number}`);
        let h = `<h5>${c.name}</h5><table class="table table-sm"><thead><tr><th>Desc</th><th>Tot</th></tr></thead><tbody>`;
        inv.lines.forEach(l=>h+=`<tr><td>${l.productName}</td><td>€ ${l.subtotal.toFixed(2)}</td></tr>`);
        h+=`</tbody></table><h4 class="text-end">Totale: € ${parseFloat(inv.total).toFixed(2)}</h4>`;
        $('#invoiceDetailModalBody').html(h);
    });
    $('#print-invoice-btn').click(()=>window.print());
    $('#company-info-form').on('submit', async function(e) { e.preventDefault(); const d={}; $(this).find('input').each(function(){if(this.id)d[this.id.replace('company-','')] = $(this).val()}); await saveDataToCloud('companyInfo', d); alert("Salvato!"); });
    $('#save-notes-btn').click(async()=>{ await saveDataToCloud('notes', {userId:currentUser.uid, text:$('#notes-textarea').val()}, currentUser.uid); alert("Salvato!"); });
});